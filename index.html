<!DOCTYPE html>
<html lang="en-GB">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>People First Research</title>
  <meta name="description" content="Latest peer-reviewed research focused on autistic, ADHD and AuDHD lives." />
  <link rel="stylesheet" href="styles.css" />
</head>

<body>
  <a class="skip-link" href="#latest">Skip to latest research</a>

  <header class="shell">
    <div class="hero">
      <div class="hero-top">
        <div>
          <h1>People First Research</h1>
          <p class="subtitle">Latest published research focused on autistic, ADHD and AuDHD lives</p>
        </div>

        <div class="hero-actions">
          <a class="btn btn-secondary" href="#latest">View latest papers</a>
          <a class="btn btn-ghost" href="#about">Read more</a>
        </div>
      </div>

      <div class="hero-card">
        <p class="lead"><strong>This page exists to centre people.</strong></p>
        <p class="muted">
          Autistic, ADHD and AuDHD people are frequently the subject of research, yet much of that
          research focuses on biology, mechanisms, or classification rather than on the everyday
          realities of living, accessing services, communicating, learning, working, and being understood.
          While such work has value, it does not always translate into meaningful improvements in quality
          of life, wellbeing, or equity.
        </p>
        <p class="lead">
          <strong>This page highlights peer-reviewed research that aims to understand and improve people’s lives.</strong>
        </p>

        <div class="meta-row" id="metaRow" aria-live="polite"></div>
      </div>
    </div>
  </header>

  <main class="shell">
    <section id="latest" class="section">
      <div class="section-head">
        <div>
          <h2>Latest research</h2>
          <p class="muted" id="countLine">Loading papers…</p>
        </div>
      </div>

      <div class="controls" role="region" aria-label="Search and filter papers">
        <div class="search-wrap">
          <label class="label" for="search">Search</label>
          <input
            type="text"
            id="search"
            placeholder="Search titles, journals, or authors"
            autocomplete="off"
          />
        </div>

        <div class="select-wrap">
          <label class="label" for="neurotype">Neurotype</label>
          <select id="neurotype">
            <option value="All">All</option>
          </select>
        </div>

        <div class="select-wrap">
          <label class="label" for="domain">Domain</label>
          <select id="domain">
            <option value="All">All</option>
          </select>
        </div>

        <div class="controls-actions">
          <button class="btn btn-secondary" id="resetBtn" type="button">Reset</button>
          <button class="btn btn-ghost" id="toggleAbstracts" type="button">Show abstracts</button>
        </div>
      </div>

      <div id="papers" class="papers" aria-live="polite"></div>
    </section>

    <section id="about" class="section">
      <details class="details" open>
        <summary>
          <span>About this page</span>
          <span class="muted">Purpose, scope, and selection criteria</span>
        </summary>

        <div class="details-body">
          <div class="grid">
            <div class="card">
              <h3>What this page includes</h3>
              <ul>
                <li>Lived experience, quality of life, wellbeing, or participation</li>
                <li>Access to healthcare, education, employment, housing, or support</li>
                <li>Communication, sensory experience, and person-centred care</li>
                <li>Service design and service improvement</li>
                <li>Supports or interventions with real-world outcomes</li>
                <li>Participatory and co-produced research approaches</li>
              </ul>
            </div>

            <div class="card">
              <h3>What this page does not include</h3>
              <ul>
                <li>Genetic, molecular, or biochemical mechanisms as the primary focus</li>
                <li>Neuroimaging or biomarker discovery as the primary focus</li>
                <li>Animal models or pre-clinical studies</li>
                <li>Theory without clear lived-experience or practice implications</li>
              </ul>
            </div>

            <div class="card wide">
              <h3>How the research is selected</h3>
              <p class="muted">
                This page is updated using an automated process that monitors selected journals and applies
                transparent inclusion and exclusion criteria to prioritise person-focused research.
                The process may miss some relevant work and may include borderline cases.
              </p>
              <p class="muted">
                Inclusion does not imply endorsement of methods, conclusions, or framing.
              </p>
            </div>
          </div>

          <div class="back-row">
            <a class="btn btn-ghost" href="#latest">Back to latest papers</a>
          </div>
        </div>
      </details>
    </section>

    <footer class="footer">
      <p class="muted">
        Built as a one-page, self-updating index. Content links out to DOI or publisher pages.
      </p>
    </footer>
  </main>

  <script>
    function normalise(str) {
      return (str || "").toLowerCase().replace(/\\s+/g, " ").trim();
    }

    function uniq(arr) {
      return Array.from(new Set(arr.filter(Boolean)));
    }

    function safeAuthors(authors) {
      if (!Array.isArray(authors) || authors.length === 0) return "";
      if (authors.length <= 4) return authors.join(", ");
      return authors.slice(0, 3).join(", ") + ", et al.";
    }

    function formatDate(p) {
      // Supports either year or published_date (ISO string)
      if (p.published_date) {
        const d = new Date(p.published_date);
        if (!Number.isNaN(d.getTime())) {
          return d.toLocaleDateString("en-GB", { day: "2-digit", month: "short", year: "numeric" });
        }
      }
      return p.year ? String(p.year) : "";
    }

    function hasArray(p, key) {
      return Array.isArray(p[key]) && p[key].length > 0;
    }

    fetch("papers.json", { cache: "no-store" })
      .then(r => r.json())
      .then(data => {
        const papers = Array.isArray(data.papers) ? data.papers : [];
        const generatedAt = data.generated_at || null;
        const sourceSummary = data.source_summary || null;

        // Elements
        const papersEl = document.getElementById("papers");
        const searchEl = document.getElementById("search");
        const neuroEl = document.getElementById("neurotype");
        const domainEl = document.getElementById("domain");
        const resetBtn = document.getElementById("resetBtn");
        const toggleAbsBtn = document.getElementById("toggleAbstracts");
        const countLine = document.getElementById("countLine");
        const metaRow = document.getElementById("metaRow");

        let showAbstracts = false;

        // Build select options from data if present
        const neurotypes = uniq(papers.flatMap(p => (p.neurotype || [])));
        const domains = uniq(papers.flatMap(p => (p.domains || [])));

        // Populate selects
        neurotypes.forEach(n => {
          const opt = document.createElement("option");
          opt.value = n;
          opt.textContent = n;
          neuroEl.appendChild(opt);
        });

        domains.sort((a, b) => a.localeCompare(b)).forEach(d => {
          const opt = document.createElement("option");
          opt.value = d;
          opt.textContent = d;
          domainEl.appendChild(opt);
        });

        // Sorting: newest first by published_date then year
        const sorted = [...papers].sort((a, b) => {
          const da = a.published_date ? Date.parse(a.published_date) : NaN;
          const db = b.published_date ? Date.parse(b.published_date) : NaN;
          if (!Number.isNaN(da) && !Number.isNaN(db)) return db - da;
          if (!Number.isNaN(db)) return 1;
          if (!Number.isNaN(da)) return -1;
          return (b.year || 0) - (a.year || 0);
        });

        // Meta line
        const metaParts = [];
        if (generatedAt) {
          const d = new Date(generatedAt);
          if (!Number.isNaN(d.getTime())) {
            metaParts.push("Last updated " + d.toLocaleString("en-GB", {
              day: "2-digit", month: "short", year: "numeric", hour: "2-digit", minute: "2-digit"
            }));
          }
        }
        if (sourceSummary) metaParts.push(sourceSummary);
        if (metaParts.length) {
          metaRow.innerHTML = metaParts.map(t => `<span class="chip chip-muted">${t}</span>`).join("");
        }

        function render(list) {
          papersEl.innerHTML = "";

          countLine.textContent = `Showing ${list.length} of ${papers.length} papers`;

          if (list.length === 0) {
            papersEl.innerHTML = `<div class="empty card"><p class="muted">No papers match your filters.</p></div>`;
            return;
          }

          list.forEach(p => {
            const title = p.title || "Untitled";
            const url = p.url || (p.doi ? `https://doi.org/${p.doi}` : "#");
            const journal = p.journal || "";
            const dateStr = formatDate(p);

            const card = document.createElement("article");
            card.className = "paper-card";

            const chips = [];

            if (hasArray(p, "neurotype")) {
              p.neurotype.slice(0, 3).forEach(n => chips.push(`<span class="chip">${n}</span>`));
            }
            if (hasArray(p, "domains")) {
              p.domains.slice(0, 3).forEach(d => chips.push(`<span class="chip chip-outline">${d}</span>`));
            }
            if (hasArray(p, "tags")) {
              p.tags.slice(0, 4).forEach(t => chips.push(`<span class="chip chip-outline">${t}</span>`));
            }

            const abstractHtml = (showAbstracts && p.abstract)
              ? `<div class="abstract"><p>${p.abstract}</p></div>`
              : "";

            card.innerHTML = `
              <div class="paper-main">
                <h3 class="paper-title">
                  <a href="${url}" target="_blank" rel="noopener">${title}</a>
                </h3>
                <p class="paper-meta">
                  ${safeAuthors(p.authors)}
                  ${journal ? ` · ${journal}` : ""}
                  ${dateStr ? ` · ${dateStr}` : ""}
                </p>
                ${chips.length ? `<div class="chips">${chips.join("")}</div>` : ""}
                ${abstractHtml}
              </div>

              <div class="paper-side">
                <a class="btn btn-secondary btn-small" href="${url}" target="_blank" rel="noopener">
                  Open
                </a>
                ${p.doi ? `<p class="doi muted">DOI: ${p.doi}</p>` : ""}
              </div>
            `;

            papersEl.appendChild(card);
          });
        }

        function applyFilters() {
          const q = normalise(searchEl.value);
          const n = neuroEl.value;
          const d = domainEl.value;

          const filtered = sorted.filter(p => {
            const hay = normalise(
              [p.title, p.journal, safeAuthors(p.authors), (p.tags || []).join(" "), (p.domains || []).join(" ")].join(" ")
            );

            const matchQ = !q || hay.includes(q);
            const matchN = (n === "All") || (Array.isArray(p.neurotype) && p.neurotype.includes(n));
            const matchD = (d === "All") || (Array.isArray(p.domains) && p.domains.includes(d));

            return matchQ && matchN && matchD;
          });

          render(filtered);
        }

        // Events
        searchEl.addEventListener("input", applyFilters);
        neuroEl.addEventListener("change", applyFilters);
        domainEl.addEventListener("change", applyFilters);

        resetBtn.addEventListener("click", () => {
          searchEl.value = "";
          neuroEl.value = "All";
          domainEl.value = "All";
          applyFilters();
        });

        toggleAbsBtn.addEventListener("click", () => {
          showAbstracts = !showAbstracts;
          toggleAbsBtn.textContent = showAbstracts ? "Hide abstracts" : "Show abstracts";
          applyFilters();
        });

        // Initial render
        applyFilters();
      })
      .catch(() => {
        document.getElementById("countLine").textContent = "Unable to load papers.";
        document.getElementById("papers").innerHTML =
          "<div class='empty card'><p class='muted'>Unable to load the research list. Please check that papers.json exists and is valid JSON.</p></div>";
      });
  </script>
</body>
</html>
